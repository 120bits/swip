<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Swip</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <style>
      html, body {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>

  <body>

    <canvas id="canvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/swip/swip.js"></script>
    <script>
      var socket = io.connect();

      var canvas = document.getElementById("canvas");
      var ctx = canvas.getContext("2d");

      canvas.setAttribute('width', window.innerWidth);
      canvas.setAttribute('height', window.innerHeight);

      ctx.fillStyle = 'black';
      ctx.fillRect(0,0, canvas.width, canvas.height);

      function getRandomColor () {
        var letters = '0123456789ABCDEF'.split('');
        var color = '#';
        for (var i = 0; i < 6; i++ ) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }

      swip.device.requestSize(function (converter) {

        socket.emit('CONNECT_CLIENT', {
          size: {
            width: converter.toAbsPixel(window.innerHeight),
            height: converter.toAbsPixel(window.innerWidth),
          }
        });

        swip.sensor.onSwipe(window, function (evt) {
          socket.emit('SWIPE', evt);
        });

        swip.sensor.onMotion(function () {
          socket.emit('LEAVE_CLUSTER');
        });

        canvas.addEventListener('click', function (evt) {
          socket.emit("CLIENT_ACTION", {
            type: "addParticle",
            data: {
              x: evt.clientX,
              y: evt.clientY,
              speedX: Math.random() * 20 -10,
              speedY: Math.random() * 20 -10,
              color: getRandomColor(),
            }
          });
        });

        socket.on('CHANGED', function (evt) {
          if (evt.cluster) {
            ctx.save();
            ctx.scale(converter.toAbsPixel(1), converter.toAbsPixel(1));
            console.log(converter.toAbsPixel(1), converter.toAbsPixel(1));
            ctx.translate(-evt.client.transform.x, -evt.client.transform.y);

            var particles = evt.cluster.data.particles;

            particles.forEach(function (particle) {
              console.log("drawing particle", particle.x, particle.y);

              ctx.fillStyle = particle.color;
              ctx.fillRect(particle.x, particle.y, 500, 500);
            });

            ctx.restore();
          }
        })
      });

    </script>
  </body>
</html>





