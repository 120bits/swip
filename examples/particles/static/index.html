<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Swip</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>

  <body>

    <div id="root"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/swip/swip.js"></script>
    <script>
      (function () {
        'use strict';

        var socket = io.connect();

        swip.init({
          socket: socket,
          container: document.getElementById('root'),
          type: 'canvas',
        }, function (client) {
          var converter = client.converter;
          var stage = client.stage;
          var ctx = stage.getContext('2d');
          ctx.fillStyle = '#333333';
          ctx.fillRect(0, 0, stage.width, stage.height);

          var blobs = [];

          client.onClick(function (evt) {
          });

          client.onDragStart(function (evt) {
            evt.position.forEach(function (pos) {
              blobs.push({
                x: pos.x,
                y: pos.y,
                speedX: 15,
                speedY: 15,
                size: 200
              });
            });
          });

          client.onDragMove(function (evt) {
            for(var i = 0; i < evt.position.length; i++) {
                blobs[i].x = evt.position[i].x;
                blobs[i].y = evt.position[i].y;
            }
          });

          client.onDragEnd(function (evt) {
            client.emit('addBlobs', { blobs: blobs } );
            blobs = [];
          });

          client.onUpdate(function (evt) {

            if (evt.cluster) {
              ctx.fillRect(0, 0, stage.width, stage.height);

              ctx.save();
              ctx.translate(-converter.toDevicePixel(evt.client.transform.x), -converter.toDevicePixel(evt.client.transform.y));
              ctx.scale(converter.toDevicePixel(1), converter.toDevicePixel(1));

              drawOpenings(ctx, evt.client);

              if (blobs) {
                for(var i = 0; i < blobs.length; i++) {
                  blobs[i].size += 0.5;
                  blobs[i].speedX = blobs[i].speedX >= 0 ? blobs[i].speedX - 0.1 : 0.1;
                  blobs[i].speedY = blobs[i].speedY >= 0 ? blobs[i].speedY - 0.1 : 0.1;
                }
              }

              blobs.forEach(function(blob) {
                ctx.beginPath();
                ctx.arc(blob.x, blob.y, blob.size , 0, 2 * Math.PI, false);
                ctx.fillStyle = '#FFFFFF';
                ctx.fill();
              });

              var updatedBlobs = evt.cluster.data.blobs;

              updatedBlobs.forEach(function (blob) {
                ctx.beginPath();
                ctx.arc(blob.x, blob.y, blob.size , 0, 2 * Math.PI, false);
                ctx.fillStyle = '#FFFFFF';
                ctx.fill();
              });

              ctx.restore();
            }
          });
        });

        function drawOpenings (ctx, client) {
          var openings = client.openings;
          var transformX = client.transform.x;
          var transformY = client.transform.y;
          var width = client.size.width;
          var height = client.size.height;

          ctx.lineWidth = 5;
          ctx.shadowBlur = 5;

          openings.left.forEach(function (wall) {
            ctx.strokeStyle = "#ff9e00";
            ctx.shadowColor = "#ff9e00";

            ctx.beginPath();
            ctx.moveTo(transformX, wall.start + transformY);
            ctx.lineTo(transformX, wall.end + transformY);
            ctx.stroke();
          });

          openings.top.forEach(function (wall) {
            ctx.strokeStyle = "#0084FF";
            ctx.shadowColor = "#0084FF";

            ctx.beginPath();
            ctx.moveTo(wall.start + transformX, transformY);
            ctx.lineTo(wall.end + transformX, transformY);
            ctx.stroke();
          });

          openings.right.forEach(function (wall) {
            ctx.strokeStyle = "#0084FF";
            ctx.shadowColor = "#0084FF";

            ctx.beginPath();
            ctx.moveTo(width + transformX, wall.start + transformY);
            ctx.lineTo(width + transformX, wall.end + transformY);
            ctx.stroke();
          });

          openings.bottom.forEach(function (wall) {
            ctx.strokeStyle = "#ff9e00";
            ctx.shadowColor = "#ff9e00";

            ctx.beginPath();
            ctx.moveTo(wall.start + transformX, height + transformY);
            ctx.lineTo(wall.end + transformX, height + transformY);
            ctx.stroke();
          });
        }
      }());
    </script>
  </body>
</html>





